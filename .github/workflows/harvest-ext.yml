name: Deploy Browser Extensions

on:
  push:
    tags:
      - '*'  # åŒ¹é…æ‰€æœ‰ tagï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: master

      - name: ç”Ÿæˆå‘è¡Œç‰ˆå˜æ›´æ—¥å¿—
        id: changelog
        shell: bash
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")

          echo "å½“å‰ TAG: $CURRENT_TAG"
          echo "ä¸Šä¸€ä¸ª TAG: $PREV_TAG"

          if [ -z "$PREV_TAG" ]; then
            RANGE=""
          else
            RANGE="$PREV_TAG..$CURRENT_TAG"
          fi

          # è·å–åŸå§‹ git logï¼ˆæ’é™¤ chore å’Œ mergeï¼‰
          RAW_LOG=$(git log $RANGE --pretty=format:"%H|%s" --no-merges | grep -v -E '^.*\|(chore|chore:)' || true)

          # åˆ†ç±»å­˜å‚¨
          FEAT=""
          FIX=""
          DOCS=""
          REFACTOR=""
          PERF=""
          TEST=""
          UPDATE=""
          OTHER=""

          while IFS='|' read -r HASH MSG; do
            [ -z "$HASH" ] && continue

            # å¦‚æœæ˜¯ GitHub PR merge æäº¤ï¼Œè·³è¿‡ï¼ˆå·²è¢«ä¸Šæ–¹ --no-merges æ’é™¤ï¼‰
            # æŸ¥è¯¢ PR æ ‡é¢˜ï¼ˆå¦‚æœ commit æåˆ° #PR_NUMBERï¼‰
            PR_TITLE=""
            if [[ "$MSG" =~ \#([0-9]+) ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
              PR_TITLE=$(gh pr view "$PR_NUM" --json title --jq '.title' 2>/dev/null || echo "")
            fi

            DISPLAY_MSG="$MSG"
            if [ -n "$PR_TITLE" ]; then
              DISPLAY_MSG="$PR_TITLE (#$PR_NUM)"
            fi

            # æ¸…æ´—å±é™©å­—ç¬¦ï¼ˆé˜²æ­¢ GitHub Actions / Shell / API å‡ºé—®é¢˜ï¼‰
            DISPLAY_MSG="${DISPLAY_MSG//\"/}"
            DISPLAY_MSG="$(printf '%s' "$DISPLAY_MSG")"

            SHORT_HASH=$(echo "$HASH" | cut -c1-7)

            if [[ "$MSG" =~ ^feat ]]; then
                FEAT+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^fix ]]; then
                FIX+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^docs ]]; then
                DOCS+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^refactor ]]; then
                REFACTOR+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^perf ]]; then
                PERF+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^test ]]; then
                TEST+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            elif [[ "$MSG" =~ ^update ]]; then
                UPDATE+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            else
                OTHER+="\n- ${DISPLAY_MSG} (${SHORT_HASH})"
            fi
          done <<< "$RAW_LOG"

          # ç»„åˆä¸­æ–‡æ—¥å¿—
          FINAL_LOG=""

          if [ -n "$FEAT" ]; then
            FINAL_LOG+="\n### âœ¨ æ–°å¢åŠŸèƒ½\n${FEAT}\n"
          fi
          if [ -n "$FIX" ]; then
            FINAL_LOG+="\n### ğŸ› ä¿®å¤é—®é¢˜\n${FIX}\n"
          fi
          if [ -n "$DOCS" ]; then
            FINAL_LOG+="\n### ğŸ“– æ–‡æ¡£æ›´æ–°\n${DOCS}\n"
          fi
          if [ -n "$REFACTOR" ]; then
            FINAL_LOG+="\n### ğŸ”¨ é‡æ„\n${REFACTOR}\n"
          fi
          if [ -n "$PERF" ]; then
            FINAL_LOG+="\n### âš¡ æ€§èƒ½ä¼˜åŒ–\n${PERF}\n"
          fi
          if [ -n "$TEST" ]; then
            FINAL_LOG+="\n### ğŸ§ª æµ‹è¯•ç›¸å…³\n${TEST}\n"
          fi
          if [ -n "$UPDATE" ]; then
            FINAL_LOG+="\n### ğŸ”„ æ›´æ–°\n${UPDATE}\n"
          fi
          if [ -n "$OTHER" ]; then
            FINAL_LOG+="\n### ğŸ“Œ å…¶ä»–å˜æ›´\n${OTHER}\n"
          fi

          # å›å†™åˆ° GitHub è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FINAL_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          cache: true

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      # æ‰“åŒ… Firefox æ’ä»¶
      - name: Zip Extension
        run: |
          echo "æ‰“åŒ…Chromeæ’ä»¶"
          pnpm run zip 
          echo "æ‰“åŒ…Firefoxæ’ä»¶"
          pnpm run zip:firefox
          echo "é‡å‘½åFirefoxæ’ä»¶"
          cp .output/harvest-addon-firefox.zip .output/harvest-addon-firefox.xpi

      # ä¸Šä¼ åˆ° Firefox æ‰©å±•å•†åº—
      - name: Upload to Firefox Add-ons
        uses: browser-actions/release-firefox-addon@latest
        with:
          addon-id: ${{ secrets.FIREFOX_GUID }}  # ä½ çš„æ’ä»¶ GUID
          addon-path: .output/harvest-addon-firefox.xpi  # ä½¿ç”¨é‡å‘½ååçš„ .xpi æ–‡ä»¶
          source-path: .output/harvest-addon-sources.zip  # ä½¿ç”¨é‡å‘½ååçš„ .xpi æ–‡ä»¶
          auth-api-issuer: ${{ secrets.FIREFOX_JWT_USER }}
          auth-api-secret: ${{ secrets.FIREFOX_SECRET }}
          approval-note: '{"scripts": {"dev": "wxt", "dev:firefox": "wxt -b firefox", "build": "wxt build", "build:firefox": "wxt build -b firefox", "zip": "wxt zip", "zip:firefox": "wxt zip -b firefox", "compile": "vue-tsc --noEmit", "postinstall": "wxt prepare"}}'


      # ä¸Šä¼ åˆ° Edge æ‰©å±•å•†åº—
      - name: Upload to Microsoft Edge Add-ons
        uses: web-scrobbler/edge-addon@v2.0.4
        with:
          product_id: ${{ secrets.EDGE_PRODUCT_ID }}
          client_id: ${{ secrets.EDGE_CLIENT_ID }}
          api_key: ${{ secrets.EDGE_CLIENT_SECRET }}
          zip: .output/harvest-addon-chrome.zip  # ä½ æ‰“åŒ…çš„ Edge æ’ä»¶è·¯å¾„
          notes: | # å¯æ ¹æ®å‘å¸ƒè¯´æ˜è‡ªåŠ¨ç”Ÿæˆ
            Edge æ’ä»¶æµ‹è¯•
            æµ‹è¯•åœ°å€ï¼šhttp://ext.ptools.fun/
            å®‰å…¨ Tokenï¼šzP5wIZzo

      - name: å‘å¸ƒ Firefox ç‰ˆæœ¬åˆ° GitHub Releases
        uses: softprops/action-gh-release@v2  # å‘å¸ƒ GitHub Release
        with:
          token: ${{ secrets.TOKEN_GITHUB }}
          files: |
            .output/harvest-addon-chrome.zip
            .output/harvest-addon-firefox.xpi
            .output/harvest-addon-firefox.zip
            .output/harvest-addon-sources.zip
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}  # ä½¿ç”¨ tag æˆ–æäº¤å“ˆå¸Œå‘½å
          name: Release ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || github.sha }}
          draft: ${{ startsWith(github.ref, 'refs/tags/') == false }}  # å¦‚æœä¸æ˜¯ tagï¼Œä½œä¸ºè‰ç¨¿
          prerelease: false  # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          body: |
            ## ğŸ“Œ æ›´æ–°æ—¥å¿—
            ${{ steps.changelog.outputs.changelog }}